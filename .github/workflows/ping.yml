name: Ping otello-web.onrender.com (artifacts)

on:
  schedule:
    # ogni 15 minuti dalle 07:30 alle 22:15, da lunedì (1) a sabato (6)
    - cron: '30,45 7 * * 1-6'         # 07:30 e 07:45
    - cron: '0,15,30,45 8-21 * * 1-6' # 08:00–21:45 ogni 15 min
    - cron: '0,15 22 * * 1-6'         # 22:00 e 22:15
  workflow_dispatch:                   # avvio manuale per test

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Esegui ping e registra log
        id: ping_otello
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://otello-web.onrender.com || echo "ERR")
          echo "$TIMESTAMP | https://otello-web.onrender.com | HTTP $STATUS" >> log.txt

      - name: Notifica Telegram se il ping fallisce
        if: failure()
        run: |
          SITE="https://otello-web.onrender.com"
          # Se curl ha fallito, proviamo a catturare dettagli del errore
          ERRORS=$(curl -v https://otello-web.onrender.com 2>&1 || echo "Errore sconosciuto")
          # Invia messaggio
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="⚠️ Ping fallito su *${SITE}*.\nDettagli:\n\`\`\`\n${ERRORS}\n\`\`\`"

      - name: Salva il log come artifact
        uses: actions/upload-artifact@v4
        with:
          name: ping-log-otello
          path: log.txt
