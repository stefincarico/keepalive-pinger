name: Ping demosite.com

on:
  schedule:
    # ogni 15 minuti dalle 07:30 alle 22:15, da lunedì (1) a sabato (6)
    - cron: '30,45 7 * * 1-6'         # 07:30 e 07:45
    - cron: '0,15,30,45 8-21 * * 1-6' # 08:00–21:45 ogni 15 min
    - cron: '0,15 22 * * 1-6'         # 22:00 e 22:15
  workflow_dispatch:                   # avvio manuale per test

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: otello-web.onrender.com
        id: ping_otello
        run: |
          set -o pipefail
          curl -v https://otello-web.onrender.com/ 2>error.log

      - name: Notify Telegram on failure
        if: failure()
        run: |
          SITE="https://otello-web.onrender.com/"
          ERRORS=$(cat error.log 2>/dev/null || echo "Errore sconosciuto")
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="⚠️ Ping fallito su *${SITE}*.\nDettagli:\n\`\`\`\n${ERRORS}\n\`\`\`"
